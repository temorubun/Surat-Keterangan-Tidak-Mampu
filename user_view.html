<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kawe Nia ‚Ä¢ Layanan SKTM</title>
  <style>
    
    :root{
      --bg:#0b1020;          /* latar belakang halaman */
      --panel:#0f172a;       /* dasar kartu */
      --ink:#e5e7eb;         /* teks utama */
      --muted:#9ca3af;       /* teks sekunder */
      --accent:#22c55e;      /* aksen hijau */
      --accent-2:#38bdf8;    /* aksen biru */
      --line:#1f2937;        /* garis tipis border */
      --danger:#ef4444;
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --space: clamp(14px, 2.4vw, 22px);
    }

    /* ====== Reset kecil agar teks selalu wrap dan tidak terpotong ====== */
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, #16223f 0%, transparent 60%),
        linear-gradient(145deg,#0a0e1a,#0f1933 55%,#0a0e1a);
    }
    /* Pastikan SEMUA elemen bisa mengecil dan membungkus teks panjang */
    body, body *{
      min-width:0;                   /* izinkan shrink di flex/grid */
      overflow-wrap:anywhere;        /* bungkus kata sangat panjang/URL */
      word-break:break-word;         /* jaga kalau ada string tanpa spasi */
      white-space:normal;            /* jangan paksa satu baris */
    }

    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }

    /* Header */
    .topbar{ display:flex; align-items:center; gap:16px; margin-bottom:18px }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0 }
    .brand img{
      width:44px; height:44px; object-fit:cover; border-radius:10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.35)
    }
    .brand .title{ font-weight:700; font-size: clamp(16px,2.4vw,20px) }
    .brand .sub{ font-size:12px; color:var(--muted) }
    .pill{
      margin-left:auto; display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1;
      background:linear-gradient(180deg, rgba(56,189,248,.2), rgba(34,197,94,.15));
      border:1px solid rgba(148,163,184,.3); padding:6px 10px; border-radius:999px;
      flex-shrink:0;
    }

    /* Main Card */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(148,163,184,.2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      display:flex; flex-wrap:wrap; gap:14px; align-items:center; justify-content:space-between;
      padding: clamp(14px, 2.2vw, 20px) var(--space);
      background:
        radial-gradient(800px 300px at 10% -20%, rgba(56,189,248,.15), transparent 60%),
        radial-gradient(600px 300px at 90% -30%, rgba(34,197,94,.18), transparent 55%);
      border-bottom:1px solid rgba(148,163,184,.2);
    }
    /* Increased gap and added margin-bottom for better spacing */
    .hgroup{ display:flex; flex-direction:column; gap:8px; min-width:0; margin-bottom:4px }
    .h1{ font-size: clamp(18px, 2.8vw, 26px); font-weight:800; letter-spacing:.3px; margin-bottom:2px }
    .h2{ font-size: 13px; color: var(--muted); margin-top:2px }
    .badges{ display:flex; gap:8px; flex-wrap:wrap; min-width:0; margin-top:6px }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:#0b1224; border:1px solid rgba(148,163,184,.26)
    }
    .badge.success{ border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.12); color:#d1fae5 }
    .badge.info{ border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.12); color:#cffafe }

    /* Content Grid */
    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:0; min-height:360px;
    }
    @media (max-width: 960px){ .grid{ grid-template-columns: 1fr } }
    @media (max-width: 960px){
      .side{ background: transparent; }
      .panel{ border-right: none; }
    }

    .panel{
      padding: var(--space);
      border-right:1px solid rgba(148,163,184,.16);
    }
    .panel:last-child{ border-right:none }

    /* Section titles */
    .stitle{
      font-size:13px; letter-spacing:.4px; text-transform:uppercase;
      color:#a5b4fc; font-weight:700; margin-bottom:10px
    }

    /* Identity table */
    .ident{
      display:grid;
      grid-template-columns: 180px 12px 1fr; /* label : ':' : nilai */
      gap:8px 12px; align-items:start; font-size:14px;
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.15);
      border-radius:14px; padding:14px;
    }
    /* Adaptasi label agar tidak memaksa potong saat layar kecil */
    @media (max-width: 560px){
      .ident{ grid-template-columns: 110px 10px 1fr }
    }
    .lab{ color:#cbd5e1 }
    .sep{ color:#475569 }
    .val{ color:#e5e7eb; font-weight:600; line-height:1.5 }

    /* Keterangan list */
    ol.ket{ margin:10px 0 0 18px; padding:0 }
    ol.ket li{ margin:8px 0; line-height:1.5 }

    .note{
      margin-top:12px; font-size:12.5px; color:#a5b4fc;
      background:rgba(99,102,241,.1);
      border:1px dashed rgba(99,102,241,.35);
      border-radius:12px; padding:10px 12px
    }

    /* Right panel: actions */
    .side{
      display:flex; flex-direction:column; gap:14px; padding: var(--space);
      background: linear-gradient(180deg, rgba(2,6,23,.35), rgba(2,6,23,.15));
    }
    .callout{
      border:1px solid rgba(56,189,248,.35); background: rgba(56,189,248,.1);
      border-radius:14px; padding:12px 14px; font-size:13px; color:#e0f2fe
    }
    .actions{ display:flex; flex-wrap:wrap; gap:10px }
    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700; letter-spacing:.3px;
      background:#0b1224; color:#e5e7eb; padding:10px 14px; border-radius:12px;
      border:1px solid rgba(148,163,184,.3);
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(34,197,94,.9), rgba(16,185,129,.9));
      border-color: rgba(16,185,129,.9); color:#052e1a
    }
    .btn.ghost{ background: transparent }
    .btn:active{ transform: translateY(1px) }

    /* Edit mode styles */
    .edit-mode .val {
      display: none;
    }
    .edit-mode .edit-field {
      display: block;
    }
    .edit-field {
      display: none;
      width: 100%;
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(56,189,248,.4);
      border-radius: 8px;
      padding: 8px 10px;
      color: #e5e7eb;
      font-size: 14px;
      font-weight: 600;
    }
    .edit-field:focus {
      outline: none;
      border-color: rgba(56,189,248,.8);
      box-shadow: 0 0 0 2px rgba(56,189,248,.2);
    }
    .edit-actions {
      display: none;
      gap: 10px;
      margin-top: 16px;
    }
    .edit-mode .edit-actions {
      display: flex;
    }
    .btn.success {
      background: linear-gradient(180deg, rgba(34,197,94,.9), rgba(16,185,129,.9));
      border-color: rgba(16,185,129,.9); 
      color: #052e1a;
    }
    .btn.danger {
      background: linear-gradient(180deg, rgba(239,68,68,.9), rgba(220,38,38,.9));
      border-color: rgba(220,38,38,.9); 
      color: #fef2f2;
    }

    /* File upload styles */
    .file-upload-container {
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.15);
      border-radius: 14px;
      padding: 14px;
    }
    
    .file-info {
      background: rgba(34,197,94,.1);
      border: 1px solid rgba(34,197,94,.3);
      border-radius: 8px;
      padding: 8px 10px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #d1fae5;
    }
    
    .file-info.error {
      background: rgba(239,68,68,.1);
      border-color: rgba(239,68,68,.3);
      color: #fee2e2;
    }
    
    .upload-progress {
      width: 100%;
      height: 4px;
      background: rgba(148,163,184,.2);
      border-radius: 2px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .upload-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Uploaded files styles */
    .uploaded-files-container {
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.15);
      border-radius: 14px;
      padding: 14px;
      min-height: 60px;
    }
    
    .no-files-message {
      color: #9ca3af;
      font-size: 13px;
      text-align: center;
      font-style: italic;
    }
    
    .uploaded-file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: rgba(34,197,94,.1);
      border: 1px solid rgba(34,197,94,.3);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .uploaded-file-item:last-child {
      margin-bottom: 0;
    }
    
    .file-icon {
      font-size: 16px;
      color: #22c55e;
      flex-shrink: 0;
    }
    
    .file-details {
      flex: 1;
      min-width: 0;
    }
    
    .file-name {
      color: #d1fae5;
      font-weight: 600;
      margin-bottom: 2px;
      word-break: break-all;
    }
    
    .file-meta {
      color: #a5b4fc;
      font-size: 11px;
    }
    
    .file-remove {
      background: rgba(239,68,68,.1);
      border: 1px solid rgba(239,68,68,.3);
      color: #fee2e2;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 10px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .file-remove:hover {
      background: rgba(239,68,68,.2);
    }

    /* Footer */
    .card-footer{
      display:flex; gap:14px; justify-content:space-between; align-items:center;
      padding: 12px var(--space); border-top:1px solid rgba(148,163,184,.2);
      color:var(--muted); font-size:12px
    }

    /* Custom Popup Styles */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    
    .popup {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(148,163,184,.3);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      position: relative;
      animation: popupSlideIn 0.3s ease-out;
    }
    
    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .popup-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }
    
    .popup-title {
      font-size: 20px;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 15px;
      letter-spacing: 0.5px;
    }
    
    .popup-message {
      font-size: 14px;
      color: #cbd5e1;
      line-height: 1.6;
      margin-bottom: 25px;
    }
    
    .popup-btn {
      background: linear-gradient(180deg, rgba(34,197,94,.9), rgba(16,185,129,.9));
      border: none;
      color: #052e1a;
      padding: 12px 30px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .popup-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(34,197,94,.3);
    }
    
    .popup-btn:active {
      transform: translateY(0);
    }

    /* Print */
    @media print{
      .side{ display:none }
      body{ background:#fff }
      .card{ border:none; box-shadow:none }
      .pill{ display:none }
      .popup-overlay{ display:none !important }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top Bar -->
    <div class="topbar">
      <div class="brand">
        <!-- Updated LogoURL reference from $json.data[0] to $json[0] -->
  <img class="logo" id="LogoURL" src="" alt="Lambang Kabupaten">
        <div>
          <div class="title">Kawe Nia ‚Ä¢ Pelayanan Masyarakat</div>
          <div class="sub">Distrik Wania, Kabupaten Mimika</div>
        </div>
      </div>
      <div class="pill">Layanan aktif ‚Ä¢ 24/7</div>
    </div>

    <!-- Main Card -->
    <section class="card" role="region" aria-label="Layanan SKTM">
      <header class="card-header">
        <div class="hgroup">
          <!-- Updated JSON structure from $json[0] to $json.data[0] -->
          <div class="h1" id="jenis_surat"></div>
          <div class="h2">Nomor:
            <span class="mono" id="nomor_surat"></span>
          </div>
        </div>
        <div class="badges">
          <span class="badge info">Status: Menunggu Tanda Tangan</span>
        </div>
      </header>

      <div class="grid">
        <!-- Left: Data & Keterangan -->
        <div class="panel">
          <div class="stitle">Data Pemohon</div> 
          <button class="btn ghost" onclick="toggleEditMode()" id="editBtn" style="margin-bottom: 12px;">‚úèÔ∏è Edit Data</button>
          <div class="ident" aria-label="Identitas Pemohon">
            <!-- Updated all pemohon data references to use $json.data[0] structure -->
            <div class="lab">Nama</div><div class="sep">:</div>
            <div class="val" id="nama"></div>
            <input type="text" class="edit-field" id="editNama" value="{{ $json.data[0].pemohon.nama }}" placeholder="Masukkan nama lengkap">
            
            <div class="lab">NIK</div><div class="sep">:</div>
            <div class="val mono" id="nik"></div>
            <input type="text" class="edit-field" id="editNIK" value="{{ $json.data[0].pemohon.nik }}" placeholder="Masukkan NIK">
            
            <div class="lab">Tempat/Tgl Lahir</div><div class="sep">:</div>
            <div class="val" id="ttl"></div>
            <input type="text" class="edit-field" id="editTTL" value="{{ $json.data[0].pemohon.ttl }}" placeholder="Contoh: Jakarta, 15 Januari 1990">
            
            <div class="lab">Agama</div><div class="sep">:</div>
            <div class="val" id="agama"></div>
            <input type="text" class="edit-field" id="editAgama" value="{{ $json.data[0].pemohon.agama }}" placeholder="Masukkan agama">
            
            <div class="lab">Jenis Kelamin</div><div class="sep">:</div>
            <div class="val" id="jenis_kelamin"></div>
            <select class="edit-field" id="editJenisKelamin">
              <option value="LAKI-LAKI" {{ $json.data[0].pemohon.jenis_kelamin == 'LAKI-LAKI' ? 'selected' : '' }}>Laki-laki</option>
              <option value="PEREMPUAN" {{ $json.data[0].pemohon.jenis_kelamin == 'PEREMPUAN' ? 'selected' : '' }}>Perempuan</option>
            </select>
            
            <div class="lab">Status Perkawinan</div><div class="sep">:</div>
            <div class="val" id="status_perkawinan"></div>
            <select class="edit-field" id="editStatusPerkawinan">
              <option value="BELUM KAWIN" {{ $json.data[0].pemohon.status_perkawinan == 'BELUM KAWIN' ? 'selected' : '' }}>Belum Kawin</option>
              <option value="KAWIN" {{ $json.data[0].pemohon.status_perkawinan == 'KAWIN' ? 'selected' : '' }}>Kawin</option>
              <option value="CERAI HIDUP" {{ $json.data[0].pemohon.status_perkawinan == 'CERAI HIDUP' ? 'selected' : '' }}>Cerai Hidup</option>
              <option value="CERAI MATI" {{ $json.data[0].pemohon.status_perkawinan == 'CERAI MATI' ? 'selected' : '' }}>Cerai Mati</option>
            </select>
            
            <div class="lab">Pekerjaan</div><div class="sep">:</div>
            <div class="val" id="pekerjaan"></div>
            <input type="text" class="edit-field" id="editPekerjaan" value="{{ $json.data[0].pemohon.pekerjaan }}" placeholder="Masukkan pekerjaan">
            
            <div class="lab">Alamat</div><div class="sep">:</div>
            <div class="val" id="alamat"></div>
            <textarea class="edit-field" id="editAlamat" placeholder="Masukkan alamat lengkap" rows="2">{{ $json.data[0].pemohon.alamat }}</textarea>

            <div class="lab">Kelurahan</div><div class="sep">:</div>
            <div class="val" id="kelurahan"></div>
            <input type="text" class="edit-field" id="editKelurahan" value="{{ $json.data[0].pemohon.kelurahan }}" placeholder="Masukkan kelurahan">
            
            <div class="lab">Kecamatan</div><div class="sep">:</div>
            <div class="val" id="kecamatan"></div>
            <input type="text" class="edit-field" id="editKecamatan" value="{{ $json.data[0].pemohon.kecamatan }}" placeholder="Masukkan kecamatan">
            
            <div class="lab">Kota/Kabupaten</div><div class="sep">:</div>
            <div class="val" id="kota_kab"></div>
            <input type="text" class="edit-field" id="editKotaKab" value="{{ $json.data[0].pemohon.kota_kab }}" placeholder="Masukkan kota/kabupaten">
            
            <div class="lab">Provinsi</div><div class="sep">:</div>
            <div class="val" id="provinsi"></div>
            <input type="text" class="edit-field" id="editProvinsi" value="{{ $json.data[0].pemohon.provinsi }}" placeholder="Masukkan provinsi">
          </div>
          <div class="edit-actions">
            <button class="btn success" onclick="saveChanges()">üíæ Simpan Perubahan</button>
            <button class="btn danger" onclick="cancelEdit()">‚ùå Batal</button>
          </div>
          
          <!-- Improved file upload section with better multiple file handling -->
          <div class="stitle" style="margin-top:10px">Lampiran </div>
          <div class="callout" style="border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.08); color:#fee2e2">
            <div>Foto rumah, surat keterangan RT/RW, atau kartu BPJS dapat dilampirkan di sini.</div>
          </div>
          <div class="stitle" style="margin-top:10px">Upload File</div>
          <div class="file-upload-container" 
               ondragover="handleDragOver(event)" 
               ondragleave="handleDragLeave(event)" 
               ondrop="handleDrop(event)">
            <input type="file" id="fileInput" accept="*" multiple style="display: none;" onchange="handleFileSelect(event)">
            <button class="btn ghost" onclick="document.getElementById('fileInput').click()" style="width: 100%; margin-bottom: 8px;">
              üìÅ Pilih File
            </button>
            <div style="font-size: 11px; color: #9ca3af; text-align: center; margin-bottom: 8px;">
              (PDF, DOC, XLS, PPT, ZIP, RAR, dll)
            </div>
            <div id="fileInfo" style="display: none;"></div>
            <div id="uploadProgress" class="upload-progress" style="display: none;">
              <div id="uploadProgressBar" class="upload-progress-bar"></div>
            </div>
            <button class="btn primary" id="uploadBtn" onclick="uploadFiles()" style="width: 100%; display: none;">
              üì§ Kirim File
            </button>
          </div>

          <!-- Added uploaded files display section -->
          <div class="stitle" style="margin-top:16px">File Terupload</div>
          <div class="uploaded-files-container">
            <div id="uploadedFilesList">
              <div class="no-files-message">Belum ada file yang diupload</div>
            </div>
          </div>
          


          
          <div class="note">
            Catatan: Periksa Data Sebelum Buat Surat.
          </div>

          <!-- Keterangan Section -->
          <div class="stitle" style="margin-top:16px">Keterangan</div>
            <div class="file-upload-container"  style="margin-bottom: 16px; line-height: 1.6; font-size: 14px;">
            <div style="margin-bottom: 8px;">
              1. Tersebut namanya diatas adalah benar - benar penduduk <strong id="keterangan_kelurahan"></strong>
            </div>
            <div style="margin-bottom: 8px;">
              2. Tersebut namanya diatas adalah benar - berstatus ekonomi lemah yang tidak mampu menebus atau membayar biaya pengobatan <strong>BPJS / KIS</strong>
            </div>
            <div style="margin-bottom: 8px;">
              3. Mohon surat keterangan ini digunakan sebagaimana mestinya.
            </div>
            <div style="margin-top: 12px; font-style: italic;">
              Demikian surat keterangan tidak mampu ini, kami buat untuk dapat digunakan sebagaimana mestinya.
            </div>
          </div>
        </div>

        <!-- Right: Actions & Meta -->
        <aside class="side">
          <div class="stitle">Tindakan</div>
          <div class="actions">
            <button class="btn primary" onclick="generateAndSendLetter()">Buat Surat & Kirim Data</button>
            <button class="btn danger" onclick="deleteLetterAndData()">Hapus Surat & Hapus Data</button>
          </div>

          <div class="stitle" style="margin-top:10px">Ringkasan</div>
          <div class="callout">
            <div><b>Operator:</b> <span id="operator"></span></div>
            <div><b>Tanggal:</b> <span id="tanggal_surat"></span></div>
            <div><b>Referensi:</b> <span id="ref"></span></div>
            <div><b>From:</b> <span id="WAHA_Trigger_payload_from"></span></div>
          </div>

          
        </aside>
      </div>

      <footer class="card-footer">
  <div>¬© <span id="tahun"></span> Pemerintah Distrik Wania ‚Ä¢ Kawe Nia</div>
      </footer>
    </section>
  </div>

  <!-- Custom Popup for Create Letter -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <div class="popup-icon">üìÑ</div>
      <div class="popup-title">Surat Berhasil Dibuat</div>
      <div class="popup-message">
        Data dan surat Anda sudah berhasil dikirim ke kantor. Mohon tunggu notifikasi selanjutnya untuk tanda tangan dari Kepala Distrik.
      </div>
      <button class="popup-btn" onclick="closePopup()">OK</button>
    </div>
  </div>


<script>
/* =========================
   1) KONFIGURASI & ENDPOINT
   ========================= */
const WEBHOOK_CREATE  = 'https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d';
const WEBHOOK_UPDATE  = 'https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/e1863045-3bfd-497d-b8a3-fc2c7c23eaa7';
const WEBHOOK_UPLOAD  = 'https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b';
const WEBHOOK_DELETE  = 'https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/d240d7b5-7395-4a13-9b1c-ebd4d6fe4589';
const UPDATE_STRATEGY = 'OVERWRITE_BIN';
const POLL_MS = 1000; // realtime di luar edit: 1 detik

/* =========================
   2) ID_USER & SUMBER DATA
   ========================= */
const ID_USER_RAW = "{{ $json.id }}"; // pakai ?id=... bila tidak dirender n8n
function resolveIdUser(){
  if (/\{\{\s*\$json\.id\s*\}\}/.test(ID_USER_RAW)) {
    const u = new URL(location.href);
    const q = u.searchParams.get('id');
    if (q) return q.trim();
    const segs = u.pathname.split('/').filter(Boolean);
    if (segs.length) return segs[segs.length-1];
    return "";
  }
  return (ID_USER_RAW || "").trim();
}
const ID_USER = resolveIdUser();
const JSON_URL = ID_USER ? ("https://distrikwania.com/data/" + encodeURIComponent(ID_USER)) : "";

/* =========================
   3) UTIL & ELEMEN
   ========================= */
const $ = (id) => document.getElementById(id);
function toStr(x, fb='-'){ const v=(x??'').toString().trim(); return v.length?v:fb; }
function isJSONResponse(res){ return (res.headers.get('content-type')||'').toLowerCase().includes('application/json'); }
async function hashText(txt){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(txt));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function pickObj(root){
  if (!root) return {};
  if (Array.isArray(root?.data) && root.data[0]) return root.data[0];
  if (Array.isArray(root) && root[0]) return root[0];
  return root;
}
function normalizeDocs(docs){
  const arr = Array.isArray(docs)? docs.filter(Boolean):[];
  const seen=new Set(); const out=[];
  for (const d of arr){
    const fid = d?.file_id || d?.id || d?.fileId || null;
    const hasUrl = !!(d?.view_url || d?.download_url);
    if (!fid && !hasUrl) continue;
    const key = fid ? `fid:${fid}` : `name:${(d?.name||'').toLowerCase()}|size:${d?.size||0}`;
    if (seen.has(key)) continue; seen.add(key);
    out.push({
      label: d?.label ?? d?.name ?? '-',
      name:  d?.name  ?? d?.label ?? '-',
      file_id: fid,
      view_url: d?.view_url ?? null,
      download_url: d?.download_url ?? null
    });
  }
  return out;
}

/* =========================
   4) STATE GLOBAL
   ========================= */
let lastJSON=null, lastObj={}, lastHash=null;
let editMode=false, pollHandle=null;
let pendingFiles=[];

/* =========================
   5) PETA ELEMEN
   ========================= */
const VIEW = {
  logo: $('LogoURL'),
  jenis_surat: $('jenis_surat'),
  nomor_surat: $('nomor_surat'),
  operator: $('operator'),
  tanggal_surat: $('tanggal_surat'),
  ref: $('ref'),
  from: $('WAHA_Trigger_payload_from'),
  tahun: $('tahun'),
  // pemohon
  nama: $('nama'), nik: $('nik'), ttl: $('ttl'), agama: $('agama'),
  jenis_kelamin: $('jenis_kelamin'), status_perkawinan: $('status_perkawinan'),
  pekerjaan: $('pekerjaan'), alamat: $('alamat'),
  kelurahan: $('kelurahan'), kecamatan: $('kecamatan'),
  kota_kab: $('kota_kab'), provinsi: $('provinsi'),
  ket_kel: $('keterangan_kelurahan'),
  // files
  filesList: $('uploadedFilesList')
};
const EDIT = {
  nama: $('editNama'), nik: $('editNIK'), ttl: $('editTTL'), agama: $('editAgama'),
  jk: $('editJenisKelamin'), status: $('editStatusPerkawinan'), pekerjaan: $('editPekerjaan'),
  alamat: $('editAlamat'), kelurahan: $('editKelurahan'), kecamatan: $('editKecamatan'),
  kota_kab: $('editKotaKab'), provinsi: $('editProvinsi'),
};
const elFileInput=$('fileInput'), elFileInfo=$('fileInfo'), elUploadBtn=$('uploadBtn');
const elProg=$('uploadProgress'), elProgBar=$('uploadProgressBar');
const popupOverlay=$('popupOverlay');

/* =========================
   6) RENDERING
   ========================= */
function renderStatic(){ if (VIEW.tahun) VIEW.tahun.textContent = String(new Date().getFullYear()); }
function renderFiles(obj){
  const wrap = VIEW.filesList; if (!wrap) return;
  const docs = normalizeDocs(obj?.dokumen);
  wrap.innerHTML = '';
  if (!docs.length){
    const div = document.createElement('div');
    div.className='no-files-message'; div.textContent='Belum ada file yang diupload';
    wrap.appendChild(div); return;
  }
  docs.forEach(d=>{
    const row=document.createElement('div');
    row.className='uploaded-file-item';
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';

    const left=document.createElement('div');
    const name = toStr(d.name);
    const fid  = d.file_id ? `<code style="font-size:12px;opacity:.85">${d.file_id}</code>` : '<i style="font-size:12px;opacity:.6">ID tidak tersedia</i>';
    left.innerHTML = `<div class="file-name">${name}</div><div>${fid}</div>`;

    const right=document.createElement('div');
    right.style.display='flex'; right.style.gap='8px';
    if (d.view_url){ const a=document.createElement('a'); a.href=d.view_url; a.target='_blank'; a.rel='noopener'; a.textContent='Lihat'; a.className='btn ghost'; right.appendChild(a); }
    if (d.download_url){ const a=document.createElement('a'); a.href=d.download_url; a.target='_blank'; a.rel='noopener'; a.textContent='Unduh'; a.className='btn ghost'; right.appendChild(a); }
    if (d.file_id){ const del=document.createElement('button'); del.className='btn danger'; del.textContent='Hapus'; del.onclick=()=>deleteDocumentsByFileIds([d.file_id]); right.appendChild(del); }

    row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
  });
}
function renderView(obj){
  if (VIEW.jenis_surat) VIEW.jenis_surat.textContent = toStr(obj.jenis_surat,'Surat Keterangan Tidak Mampu (SKTM)');
  if (VIEW.nomor_surat) VIEW.nomor_surat.textContent = toStr(obj.nomor_surat,'‚Äî');
  if (VIEW.operator) VIEW.operator.textContent = toStr(obj.operator,'‚Äî');
  if (VIEW.tanggal_surat) VIEW.tanggal_surat.textContent = toStr(obj.tanggal_surat, new Date().toLocaleDateString('id-ID'));
  if (VIEW.ref) VIEW.ref.textContent = toStr(obj.ref, ID_USER || '‚Äî');
  if (VIEW.from) VIEW.from.textContent = toStr(obj.WAHA_Trigger_payload_from,'‚Äî');
  if (VIEW.logo){ const logo=obj.LogoURL||obj.logo_url||''; if (logo) VIEW.logo.src=logo; }

  const p=obj.pemohon||{};
  if (VIEW.nama) VIEW.nama.textContent = toStr(p.nama);
  if (VIEW.nik) VIEW.nik.textContent = toStr(p.nik);
  if (VIEW.ttl) VIEW.ttl.textContent = toStr(p.ttl);
  if (VIEW.agama) VIEW.agama.textContent = toStr(p.agama);
  if (VIEW.jenis_kelamin) VIEW.jenis_kelamin.textContent = toStr(p.jenis_kelamin);
  if (VIEW.status_perkawinan) VIEW.status_perkawinan.textContent = toStr(p.status_perkawinan);
  if (VIEW.pekerjaan) VIEW.pekerjaan.textContent = toStr(p.pekerjaan);
  if (VIEW.alamat) VIEW.alamat.textContent = toStr(p.alamat);
  if (VIEW.kelurahan) VIEW.kelurahan.textContent = toStr(p.kelurahan);
  if (VIEW.kecamatan) VIEW.kecamatan.textContent = toStr(p.kecamatan);
  if (VIEW.kota_kab) VIEW.kota_kab.textContent = toStr(p.kota_kab);
  if (VIEW.provinsi) VIEW.provinsi.textContent = toStr(p.provinsi);
  if (VIEW.ket_kel) VIEW.ket_kel.textContent = toStr(p.kelurahan);

  // seed field edit
  if (EDIT.nama) EDIT.nama.value = p.nama ?? '';
  if (EDIT.nik) EDIT.nik.value = p.nik ?? '';
  if (EDIT.ttl) EDIT.ttl.value = p.ttl ?? '';
  if (EDIT.agama) EDIT.agama.value = p.agama ?? '';
  if (EDIT.jk) EDIT.jk.value = p.jenis_kelamin ?? 'LAKI-LAKI';
  if (EDIT.status) EDIT.status.value = p.status_perkawinan ?? 'BELUM KAWIN';
  if (EDIT.pekerjaan) EDIT.pekerjaan.value = p.pekerjaan ?? '';
  if (EDIT.alamat) EDIT.alamat.value = p.alamat ?? '';
  if (EDIT.kelurahan) EDIT.kelurahan.value = p.kelurahan ?? '';
  if (EDIT.kecamatan) EDIT.kecamatan.value = p.kecamatan ?? '';
  if (EDIT.kota_kab) EDIT.kota_kab.value = p.kota_kab ?? '';
  if (EDIT.provinsi) EDIT.provinsi.value = p.provinsi ?? '';

  renderFiles(obj);
}

/* =========================
   7) POLLING REALTIME (1s)
   ========================= */
function startPolling(){ stopPolling(); pollHandle=setInterval(()=>{ if(!editMode) loadOnce(); }, POLL_MS); }
function stopPolling(){ if(pollHandle){ clearInterval(pollHandle); pollHandle=null; } }

/* =========================
   8) MODE EDIT & SIMPAN (UPDATE)
   ========================= */
function toggleEditMode(){
  editMode = !editMode;
  document.body.classList.toggle('edit-mode', editMode);
  const btn = $('editBtn'); if (btn) btn.textContent = editMode ? 'üîí Selesai Edit' : '‚úèÔ∏è Edit Data';
  if (editMode) stopPolling(); else { loadOnce(); startPolling(); }
}
function cancelEdit(){ renderView(lastObj||{}); if (editMode) toggleEditMode(); }

/* ‚ÄúSimpan Perubahan‚Äù => UPDATE */
async function saveChanges(){
  try{
    if (!lastObj || typeof lastObj!=='object') lastObj = {};
    if (!lastObj.pemohon) lastObj.pemohon = {};
    const p = lastObj.pemohon;
    p.nama = EDIT.nama?.value ?? p.nama;
    p.nik = EDIT.nik?.value ?? p.nik;
    p.ttl = EDIT.ttl?.value ?? p.ttl;
    p.agama = EDIT.agama?.value ?? p.agama;
    p.jenis_kelamin = EDIT.jk?.value ?? p.jenis_kelamin;
    p.status_perkawinan = EDIT.status?.value ?? p.status_perkawinan;
    p.pekerjaan = EDIT.pekerjaan?.value ?? p.pekerjaan;
    p.alamat = EDIT.alamat?.value ?? p.alamat;
    p.kelurahan = EDIT.kelurahan?.value ?? p.kelurahan;
    p.kecamatan = EDIT.kecamatan?.value ?? p.kecamatan;
    p.kota_kab = EDIT.kota_kab?.value ?? p.kota_kab;
    p.provinsi = EDIT.provinsi?.value ?? p.provinsi;

    const edited = JSON.parse(JSON.stringify(lastObj||{}));
    if (UPDATE_STRATEGY==='OVERWRITE_BIN') edited.dokumen = normalizeDocs(lastObj?.dokumen);
    const payload = { action:'UPDATE_ONLY', strategy:UPDATE_STRATEGY, id_user:ID_USER, data:edited };
    const resp = await fetch(WEBHOOK_UPDATE, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if (!resp.ok){ const t=await resp.text(); throw new Error('HTTP '+resp.status+' ‚Äî '+t.slice(0,200)); }

    renderView(lastObj);
    if (editMode) toggleEditMode();
    alert('Perubahan disimpan ‚úì');
  }catch(e){
    alert('Gagal menyimpan perubahan: ' + e.message);
  }
}

/* =========================
   9) MUAT DATA (dipanggil polling)
   ========================= */
async function loadOnce(){
  try{
    if (!JSON_URL) return console.warn('ID_USER kosong.');
    const res = await fetch(JSON_URL + '?t=' + Date.now(), { cache:'no-store' });
    const text = await res.text();
    if (!res.ok) throw new Error('HTTP '+res.status+' ‚Äî '+text.slice(0,200));
    let data; try{ data = JSON.parse(text); } catch(err){ if (!isJSONResponse(res)) throw new Error('Respon bukan JSON'); throw err; }
    const h = await hashText(JSON.stringify(data));
    if (h !== lastHash){
      lastHash = h; lastJSON = data; lastObj = pickObj(data) || {};
      renderView(lastObj);
    }
  }catch(e){ console.error('Load error:', e.message); }
}
function startRealtime(){ renderStatic(); loadOnce(); startPolling(); }

/* =========================
   10) AKSI: CREATE / DELETE / UPLOAD
   ========================= */
function buildPayload(base){ return { ...(base||{}), id_user: ID_USER }; }

/* === Tombol ‚ÄúBuat Surat & Kirim Data‚Äù (CREATE) === */
async function generateAndSendLetter(){
  try{
    if (editMode) await saveChanges(); // pastikan state terkini terkirim
    const resp = await fetch(WEBHOOK_CREATE, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(buildPayload(lastObj))
    });
    if (!resp.ok){ const t=await resp.text(); throw new Error('HTTP '+resp.status+' ‚Äî '+t.slice(0,200)); }
    openPopup(); // tampilkan popup sukses
  }catch(e){ alert('Gagal membuat & mengirim surat: '+e.message); }
}

/* ‚Äî Hapus seluruh data/surat ‚Äî */
async function deleteLetterAndData(){
  if (!confirm('Yakin hapus SURAT dan DATA ini?')) return;
  try{
    const resp = await fetch(WEBHOOK_DELETE, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'DELETE_ALL', id_user: ID_USER, data: buildPayload(lastObj) })
    });
    const text = await resp.text();
    if (!resp.ok){ throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200)); }
    alert('Data & surat dihapus ‚úì'); await loadOnce();
  }catch(e){ alert('Gagal menghapus: '+e.message); }
}

/* ‚Äî Upload berkas ‚Äî */
function handleFileSelect(ev){ pendingFiles = Array.from(ev.target.files||[]); refreshPendingFilesUI(); }
function handleDragOver(ev){ ev.preventDefault(); ev.stopPropagation(); ev.currentTarget.style.borderColor='rgba(56,189,248,.6)'; ev.currentTarget.style.background='rgba(56,189,248,.06)'; }
function handleDragLeave(ev){ ev.preventDefault(); ev.stopPropagation(); ev.currentTarget.style.borderColor=''; ev.currentTarget.style.background=''; }
function handleDrop(ev){ ev.preventDefault(); ev.stopPropagation(); ev.currentTarget.style.borderColor=''; ev.currentTarget.style.background=''; pendingFiles = Array.from(ev.dataTransfer.files||[]); refreshPendingFilesUI(); }
function refreshPendingFilesUI(){
  if (!elFileInfo || !elUploadBtn) return;
  if (!pendingFiles.length){ elFileInfo.style.display='none'; elUploadBtn.style.display='none'; return; }
  elFileInfo.style.display=''; elUploadBtn.style.display='';
  elFileInfo.innerHTML = '<div style="font-weight:600;margin-bottom:6px">File akan diupload:</div>' +
    pendingFiles.map(f=>`<div style="font-size:12px">${f.name}</div>`).join('');
}
async function uploadFiles(){
  try{
    if (!pendingFiles.length) return alert('Pilih minimal satu file.');
    if (!lastObj && !lastJSON) return alert('Belum ada data utama.');

    if (editMode) await saveChanges();
    const form = new FormData();
    form.append('data', JSON.stringify(buildPayload(lastObj)));
    form.append('id_user', ID_USER);
    pendingFiles.forEach(f=> form.append('files[]', f, f.name));

    if (elProg) elProg.style.display=''; if (elProgBar) elProgBar.style.width='8%';
    const resp = await fetch(WEBHOOK_UPLOAD, { method:'POST', body: form });
    const text = await resp.text();
    if (!resp.ok) throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));

    if (elProgBar) elProgBar.style.width='100%';
    alert('Upload sukses ‚úì');
    pendingFiles=[]; if (elFileInput) elFileInput.value=''; refreshPendingFilesUI();
    await loadOnce();
  }catch(e){
    alert('Upload gagal: '+e.message);
  }finally{
    setTimeout(()=>{ if (elProg) elProg.style.display='none'; }, 600);
    if (elProgBar) elProgBar.style.width='0%';
  }
}

/* =========================
   11) HAPUS DOKUMEN
   ========================= */
async function deleteDocumentsByFileIds(fileIds=[]){
  if (!fileIds.length) return;
  if (!confirm('Hapus dokumen berikut?\n'+fileIds.join('\n'))) return;
  try{
    const payload = { action:'DELETE_DOCS', id_user:ID_USER, delete_file_ids:fileIds, data: buildPayload(lastObj) };
    const resp = await fetch(WEBHOOK_UPDATE, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if (!resp.ok){ const t=await resp.text(); throw new Error('HTTP '+resp.status+' ‚Äî '+t.slice(0,200)); }
    await loadOnce(); alert('Dokumen dihapus ‚úì');
  }catch(e){ alert('Gagal menghapus dokumen: '+e.message); }
}

/* =========================
   12) POPUP
   ========================= */
function openPopup(){ if (popupOverlay) popupOverlay.style.display='flex'; }
function closePopup(){ if (popupOverlay) popupOverlay.style.display='none'; }
window.closePopup = closePopup;

/* =========================
   13) EKSPOR GLOBAL
   ========================= */
window.toggleEditMode = toggleEditMode;
window.saveChanges = saveChanges;                // tombol "Simpan Perubahan" ‚Üí UPDATE
window.cancelEdit = cancelEdit;
window.uploadFiles = uploadFiles;
window.generateAndSendLetter = generateAndSendLetter; // tombol "Buat Surat & Kirim Data" ‚Üí CREATE
window.deleteLetterAndData = deleteLetterAndData;
window.handleFileSelect = handleFileSelect;
window.handleDragOver = handleDragOver;
window.handleDragLeave = handleDragLeave;
window.handleDrop = handleDrop;

/* =========================
   14) START
   ========================= */
document.addEventListener('DOMContentLoaded', startRealtime);
</script>

</body>
</html>
