<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Editor JSON + File Upload • View/Download/Delete per Item</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <input type="file" id="fileInput" multiple>
  <script src="script.js"></script>
    });
    if(!resp.ok) throw new Error('HTTP '+resp.status+' — '+(await resp.text()).slice(0,200));
    ustat2.textContent='Update sukses ✓';
    await load();
  }catch(e){ ustat2.textContent='Error: '+e.message; }
  finally{ updateBtn.disabled=false; }
});

upBtn.addEventListener('click', async()=>{
  try{
    if(!lastObj && !lastJSON){ ust.textContent='Belum ada data'; return; }
    const files=Array.from(fileInput.files||[]);
    if(files.length===0){ ust.textContent='Pilih minimal satu file.'; return; }

    upBtn.disabled=true; ust.textContent='Mengupload…';

    const baseObj=lastObj||(Array.isArray(lastJSON)?lastJSON[0]:lastJSON)||{};
    const edited=buildPayload(baseObj);

    let dataPayload;
    if(Array.isArray(lastJSON)){ const arr=[...lastJSON]; arr[0]={...edited,id_user:ID_USER}; dataPayload=arr; }
    else { dataPayload={...edited,id_user:ID_USER}; }

    const files_info=files.map(f=>({name:f.name,size:f.size,type:f.type||null}));
    const form=new FormData();
    form.append('data', JSON.stringify(dataPayload));
    form.append('id_user', ID_USER);
    form.append('files_info', JSON.stringify(files_info));
    for(const f of files) form.append('files[]', f, f.name);

    const resp=await fetch('https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b',{ method:'POST', body:form });
    const text=await resp.text();
    if(!resp.ok) throw new Error('HTTP '+resp.status+' — '+text.slice(0,200));

    ust.textContent='Upload sukses ✓';
    fileInput.value=''; // reset input file
    await load();
  }catch(e){ ust.textContent='Upload gagal: '+e.message; }
  finally{ upBtn.disabled=false; }
});

/* ================== Hapus Dokumen ================== */
async function deleteDocumentsByFileIds(fileIds=[]){
  if(!fileIds.length) return;
  if(!confirm('Hapus '+fileIds.length+' dokumen?\n'+fileIds.join('\n'))) return;
  try{
    delDocStatus.textContent='Memproses…';
    const base=lastObj||(Array.isArray(lastJSON)?lastJSON[0]:lastJSON)||{};
    const filtered=JSON.parse(JSON.stringify(base));
    const docs=Array.isArray(filtered.dokumen)?filtered.dokumen:[];
    filtered.dokumen = normalizeDokumen(docs).filter(d=>!fileIds.includes(d?.file_id));

    let overwritePayload;
    if(Array.isArray(lastJSON)){ const arr=[...lastJSON]; arr[0]={...filtered,id_user:ID_USER}; overwritePayload=arr; }
    else { overwritePayload={...filtered,id_user:ID_USER}; }

    const resp=await fetch('https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/e1863045-3bfd-497d-b8a3-fc2c7c23eaa7',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ action:'DELETE_DOCS', id_user:ID_USER, delete_file_ids:fileIds, data:overwritePayload })
    });

    if(!resp.ok){ const t=await resp.text(); throw new Error('HTTP '+resp.status+' — '+t.slice(0,200)); }
    delDocStatus.textContent='Dokumen dihapus & data ditimpa ✓';
    await load();
  }catch(e){ delDocStatus.textContent='Gagal: '+e.message; }
}

uploadedFilesTbody.addEventListener('click',(ev)=>{
  const btn=ev.target.closest('.tight-del');
  if(!btn) return;
  const fid=btn.getAttribute('data-fileid');
  if(fid) deleteDocumentsByFileIds([fid]);
});
</script>
</body>
</html>
